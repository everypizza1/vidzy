<script>
    function like(what) {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                if (this.responseText == "Success") {
                    what.getElementsByTagName('img')[0].src = "/static/star-solid.svg";
                } else if (this.responseText == "NotLoggedIn") {
                    window.location.href = "/login";
                }
            }
        };
        xmlhttp.open("GET", "/like_post?id=" + what.parentNode.parentNode.getElementsByTagName('shortid')[0].innerText, true);
        xmlhttp.send();
    }


    elements = document.querySelectorAll(".like_button_img");

    for (var i = 0; i < elements.length; i++) {
        elem = elements[i];

        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                if (this.responseText == "true") {
                    elem.src = "/static/star-solid.svg";
                }
            }
        };
        xmlhttp.open("GET", "/if_liked_post?id=" + elem.parentNode.parentNode.parentNode.getElementsByTagName('shortid')[0].innerText, false);
        xmlhttp.send();
    }


    function share(what) {
        if (navigator.share) {
            navigator.share({
                title: "I like this video",
                text: "Come look a this video",
                url: "{{ request.host_url }}shorts/" + what.parentNode.parentNode.getElementsByTagName('shortid')[0].innerText
            })
                .then(() => console.log('Successful share'))
                .catch(error => console.log('Error sharing:', error));
        } else {
            alert("{{ request.host_url }}shorts/" + what.parentNode.parentNode.getElementsByTagName('shortid')[0].innerText);
        }
    }

    function comment(what) {
        if (currentcommentsdiv.style.display == "none") {
            currentcommentsdiv.style.display = "block";
        } else {
            currentcommentsdiv.style.display = "none";
        }
    }
</script>

<script>
    var currentcommentsdiv;

    var options = {
        root: document.querySelector('.app__videos'),
        rootMargin: '0px',
        threshold: 1.0
    };

    var ob = new IntersectionObserver((entries, observer) => {
        console.log(entries[0].isIntersecting);
        if (!entries[0].isIntersecting) {
            currentcommentsdiv = entries[0].target.parentNode.getElementsByClassName("comments")[0];
            currentcommentsdiv.style.display = "none";
        }
        else {
            entries[0].target.currentTime = 0;
            entries[0].target.play();
            currentcommentsdiv = entries[0].target.parentNode.getElementsByClassName("comments")[0];
            currentcommentsdiv.style.display = "none";
        }
    }, options);

    document.querySelectorAll('video').forEach((item) => {
        ob.observe(item);
    });


    const videos = document.querySelectorAll('video');

    for (const video of videos) {
        video.addEventListener('click', function () {
            console.log('clicked');
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        });
    }
</script>